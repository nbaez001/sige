package com.sige.gui;

import java.util.List;
import java.util.Map;

import com.sige.entidad.Lugar;
import com.sige.servicio.LugarServicio;
import com.sige.servicio.UtilService;
import com.sige.util.Boton;
import com.sige.util.Busqueda;
import com.sige.util.Constantes;
import com.sige.util.Injector;
import com.sige.util.TextField;
import com.vaadin.annotations.AutoGenerated;
import com.vaadin.data.Item;
import com.vaadin.data.Property.ValueChangeEvent;
import com.vaadin.data.Property.ValueChangeListener;
import com.vaadin.data.util.IndexedContainer;
import com.vaadin.event.FieldEvents.TextChangeEvent;
import com.vaadin.event.FieldEvents.TextChangeListener;
import com.vaadin.event.ItemClickEvent;
import com.vaadin.event.ItemClickEvent.ItemClickListener;
import com.vaadin.event.ShortcutAction.KeyCode;
import com.vaadin.event.ShortcutListener;
import com.vaadin.server.ThemeResource;
import com.vaadin.ui.AbsoluteLayout;
import com.vaadin.ui.Button;
import com.vaadin.ui.Button.ClickEvent;
import com.vaadin.ui.Button.ClickListener;
import com.vaadin.ui.ComboBox;
import com.vaadin.ui.CustomComponent;
import com.vaadin.ui.Label;
import com.vaadin.ui.Table;
import com.vaadin.ui.UI;
import com.vaadin.ui.Window;
import com.vaadin.ui.themes.Reindeer;

public class LugarBuscar extends CustomComponent implements ClickListener {

	/*- VaadinEditorProperties={"grid":"RegularGrid,20","showGrid":true,"snapToGrid":true,"snapToObject":true,"movingGuides":false,"snappingDistance":10} */

	@AutoGenerated
	private AbsoluteLayout mainLayout;
	@AutoGenerated
	private Label lblTotalPaginas;
	@AutoGenerated
	private Label lblSeparador;
	@AutoGenerated
	private Label lblPagina;
	@AutoGenerated
	private TextField txtPaginaActual;
	@AutoGenerated
	private Boton btnFin;
	@AutoGenerated
	private Boton btnSiguiente;
	@AutoGenerated
	private Boton btnAtras;
	@AutoGenerated
	private Boton btnInicio;
	@AutoGenerated
	private Button btnBuscar;
	@AutoGenerated
	private Table tblLugares;
	@AutoGenerated
	private TextField txtNombre;
	@AutoGenerated
	private Label lblNombre;
	@AutoGenerated
	private ComboBox cbxDistrito;
	@AutoGenerated
	private ComboBox cbxDepartamento;
	@AutoGenerated
	private ComboBox cbxProvincia;
	@AutoGenerated
	private Label lblDistrito;
	@AutoGenerated
	private Label lblProvincia;
	@AutoGenerated
	private Label lblDepartamento;
	/**
	 * The constructor should first build the main layout, set the composition
	 * root and then do any custom initialization.
	 * 
	 * The constructor will not be automatically regenerated by the visual
	 * editor.
	 * 
	 */
	private LugarServicio lugarServicio;
	private Window windowContiene;
	private CustomComponent quienLlama;
	private UtilService utilService;
	private Map<String, Integer> columnLenghts;

	public LugarBuscar(Window windowContiene, CustomComponent quienLlama) {
		lugarServicio = Injector.obtenerServicio(LugarServicio.class);
		utilService = Injector.obtenerServicio(UtilService.class);
		this.windowContiene = windowContiene;
		this.quienLlama = quienLlama;
		buildMainLayout();
		setCompositionRoot(mainLayout);
		postBuid();
		llenarCombos();
		getAllLugares();
		// TODO add user code here
	}

	private void llenarCombos() {
		List<Lugar> lugares = lugarServicio.getAllDepartamentos();
		llenarCombo(cbxDepartamento, lugares);
		if (!lugares.isEmpty()) {
			// String codigo=lugares.get(0).getCodigoLugar();
			String codigo = lugarServicio.getDepartamento().trim();
			cbxDepartamento.setValue(lugarServicio.getDepartamento());
			llenarProvincias(codigo.substring(0, 2));
		}

	}

	private void llenarProvincias(String idDepartamento) {
		List<Lugar> lugares = lugarServicio.getAllProvincias(idDepartamento);
		llenarCombo(cbxProvincia, lugares);
		cbxProvincia.setValue(lugarServicio.getProvincia());
		String codProvincia = lugarServicio.getProvincia();
		codProvincia = codProvincia.substring(2, 4);
		llenarDistrito(idDepartamento, codProvincia);

	}

	private void llenarDistrito(String idDepartamento, String idProvincia) {
		List<Lugar> lugares = lugarServicio.getAllDistritos(idDepartamento,
				idProvincia);
		llenarCombo(cbxDistrito, lugares);
		cbxDistrito.setValue(lugarServicio.getDistrito());
	}

	private void llenarCombo(ComboBox combo, List<Lugar> lugares) {
		combo.removeAllItems();
		for (Lugar lugar : lugares) {
			combo.addItem(lugar.getCodigoLugar());
			combo.setItemCaption(lugar.getCodigoLugar(), lugar.getNombre());
		}
	}

	private void postBuid() {
		columnLenghts = utilService.getLengthColumns("lugares");
		this.txtNombre.setMaxLength(columnLenghts.get("nombre"));
		this.btnBuscar.addClickListener((ClickListener) this);
		this.btnInicio.addClickListener((ClickListener) this);
		this.btnAtras.addClickListener((ClickListener) this);
		this.btnSiguiente.addClickListener((ClickListener) this);
		this.btnFin.addClickListener((ClickListener) this);

		this.btnInicio.setStyleName(Reindeer.BUTTON_LINK);
		this.btnAtras.setStyleName(Reindeer.BUTTON_LINK);
		this.btnSiguiente.setStyleName(Reindeer.BUTTON_LINK);
		this.btnFin.setStyleName(Reindeer.BUTTON_LINK);
		this.txtPaginaActual.setValue("1");

		cbxDepartamento.setTabIndex(1);
		cbxProvincia.setTabIndex(2);
		cbxDistrito.setTabIndex(3);
		txtNombre.setTabIndex(4);
		btnBuscar.setTabIndex(5);
		tblLugares.setTabIndex(6);
		btnInicio.setTabIndex(7);
		btnAtras.setTabIndex(8);
		txtPaginaActual.setTabIndex(9);
		btnSiguiente.setTabIndex(10);
		btnFin.setTabIndex(11);

		this.txtPaginaActual.setId("paginaActual");
		this.txtNombre.setId("buscarNombres");
		IndexedContainer container = new IndexedContainer();
		container.addContainerProperty("id", Long.class, null);
		container.addContainerProperty("item", Long.class, null);
		container.addContainerProperty("nombre", String.class, null);
		container.addContainerProperty("codigo", String.class, null);
		container.addContainerProperty("tpoLugar", String.class, null);
		tblLugares.setContainerDataSource(container);
		tblLugares.setVisibleColumns(new Object[] { "item", "nombre", "codigo",
				"tpoLugar" });
		tblLugares.setColumnWidth("item", 25);
		tblLugares.setColumnWidth("codigo", 50);
		tblLugares.setColumnWidth("nombre", 300);
		tblLugares.setColumnWidth("tpoLugar", 100);

		tblLugares.setColumnHeader("item", "Item");
		tblLugares.setColumnHeader("codigo", "Codigo");
		tblLugares.setColumnHeader("nombre", "Nombre de Lugar");
		tblLugares.setColumnHeader("tpoLugar", "Tipo de Lugar");
		tblLugares.setSelectable(true);
		tblLugares.setImmediate(true);
		cbxDepartamento.setImmediate(true);
		cbxProvincia.setImmediate(true);
		this.txtPaginaActual.setImmediate(true);
		this.tblLugares.addItemClickListener(new ItemClickListener() {
			private static final long serialVersionUID = 1L;

			@Override
			public void itemClick(ItemClickEvent event) {
				if (event.isDoubleClick()) {
					Item item = tblLugares.getItem(event.getItemId());
					respuesta(new Long(item.getItemProperty("id").getValue()
							.toString()));
				}
			}
		});
		cbxDepartamento.addValueChangeListener(new ValueChangeListener() {
			private static final long serialVersionUID = 1L;

			@Override
			public void valueChange(ValueChangeEvent event) {
				if (event.getProperty().getValue() != null) {
					llenarProvincias(event.getProperty().getValue().toString()
							.substring(0, 2));
				}
			}
		});

		cbxProvincia.addValueChangeListener(new ValueChangeListener() {
			private static final long serialVersionUID = 1L;

			@Override
			public void valueChange(ValueChangeEvent event) {
				if (event.getProperty().getValue() != null) {
					String codigo = event.getProperty().getValue().toString();
					llenarDistrito(codigo.substring(0, 2),
							codigo.substring(2, 4));
				}
			}
		});

		this.txtPaginaActual.addShortcutListener(new ShortcutListener("",
				KeyCode.ENTER, null) {
			private static final long serialVersionUID = 1L;

			@Override
			public void handleAction(Object sender, Object target) {
				if (target instanceof TextField
						&& ((TextField) target).getId().equals("paginaActual")) {
					Long paginaActual = null;
					try {
						paginaActual = Long.parseLong(txtPaginaActual
								.getValue().toString());
					} catch (Exception exception) {
						paginaActual = 1L;
					}
					txtPaginaActual.setValue(paginaActual.toString());
					getAllLugares();
				}
			}
		});

		this.txtNombre.setImmediate(true);
		this.txtNombre.addTextChangeListener(new TextChangeListener() {

			@Override
			public void textChange(TextChangeEvent event) {
				// TODO Auto-generated method stub
				txtPaginaActual.setValue("1");
				txtNombre.setValue(event.getText());
				getAllLugares();
			}
		});
	}

	@SuppressWarnings("unchecked")
	private void getAllLugares() {
		IndexedContainer container = (IndexedContainer) tblLugares
				.getContainerDataSource();
		container.removeAllItems();

		List<Lugar> lugaresListado = null;
		Long paginaActual = Long.parseLong(this.txtPaginaActual.getValue()
				.toString());
		Lugar lugarBuscar = new Lugar();
		lugarBuscar.setNombre(this.txtNombre.getValue().toString());

		if (cbxDistrito.getValue() != null) {
			lugarBuscar.setCodigoLugar(cbxDistrito.getValue().toString()
					.substring(0, 6));
		} else if (cbxProvincia.getValue() != null) {
			lugarBuscar.setCodigoLugar(cbxProvincia.getValue().toString()
					.substring(0, 4));
		} else if (cbxDepartamento.getValue() != null) {
			lugarBuscar.setCodigoLugar(cbxDepartamento.getValue().toString()
					.substring(0, 2

					));
		} else {
			lugarBuscar.setCodigoLugar("");
		}
		Busqueda busqueda = lugarServicio.buscarPorLugar(lugarBuscar,
				paginaActual);
		lugaresListado = (List<Lugar>) busqueda.getRegistos();
		this.lblTotalPaginas.setValue(busqueda.getNumeroPaginas().toString());
		this.txtPaginaActual.setValue(busqueda.getPaginaActual().toString());

		Long numeroItem = (Long.parseLong(this.txtPaginaActual.getValue()
				.toString()) - 1) * Constantes.PAGINACION.LUGAR + 1;
		for (int i = 0; i < lugaresListado.size(); i++) {
			Item item = container.addItem(i);
			item.getItemProperty("id").setValue(lugaresListado.get(i).getId());
			item.getItemProperty("item").setValue(numeroItem++);
			item.getItemProperty("nombre").setValue(
					lugaresListado.get(i).getNombre());
			item.getItemProperty("codigo").setValue(
					lugaresListado.get(i).getCodigoLugar());
			item.getItemProperty("tpoLugar").setValue(
					lugaresListado.get(i).getTipoLugar().getAbreviatura());
		}
	}

	private void respuesta(Long lugarId) {
		if (quienLlama instanceof PersonaMantenimiento) {
			PersonaMantenimiento panel = (PersonaMantenimiento) quienLlama;
			panel.getLugarSeleccionado(lugarId);
		} else if (quienLlama instanceof LugarMantenimiento) {
			LugarMantenimiento panel = (LugarMantenimiento) quienLlama;
			panel.getLugarSeleccionado(lugarId);
		} else if (quienLlama instanceof PersonaBuscar) {
			PersonaBuscar panel = (PersonaBuscar) quienLlama;
			panel.getLugarSeleccionado(lugarId);
		}
		UI.getCurrent().removeWindow(windowContiene);
	}

	@Override
	public void buttonClick(ClickEvent event) {
		if (event.getSource() == this.btnBuscar) {
			this.txtPaginaActual.setValue("1");
			getAllLugares();
		} else {
			if (event.getSource() == this.btnSiguiente) {
				Long paginaActual = Long.parseLong(this.txtPaginaActual
						.getValue().toString()) + 1;
				if (paginaActual <= Long.parseLong(this.lblTotalPaginas
						.getValue().toString())) {
					this.txtPaginaActual.setValue(paginaActual.toString());
				}
				getAllLugares();
			} else {
				if (event.getSource() == this.btnAtras) {
					Long paginaActual = Long.parseLong(this.txtPaginaActual
							.getValue().toString()) - 1;
					if (paginaActual >= 1) {
						this.txtPaginaActual.setValue(paginaActual.toString());
					}
					getAllLugares();
				} else {
					if (event.getSource() == this.btnInicio) {
						this.txtPaginaActual.setValue("1");
						getAllLugares();
					} else {
						if (event.getSource() == this.btnFin) {
							this.txtPaginaActual.setValue(this.lblTotalPaginas
									.getValue());
							getAllLugares();
						}
					}
				}
			}
		}

	}

	@AutoGenerated
	private AbsoluteLayout buildMainLayout() {
		// common part: create layout
		mainLayout = new AbsoluteLayout();
		mainLayout.setImmediate(false);
		mainLayout.setWidth("100%");
		mainLayout.setHeight("100%");

		// top-level component properties
		setWidth("100.0%");
		setHeight("100.0%");

		// lblDepartamento
		lblDepartamento = new Label();
		lblDepartamento.setImmediate(false);
		lblDepartamento.setWidth("-1px");
		lblDepartamento.setHeight("-1px");
		lblDepartamento.setValue("Departamento");
		mainLayout.addComponent(lblDepartamento, "top:10.0px;left:20.0px;");

		// lblProvincia
		lblProvincia = new Label();
		lblProvincia.setImmediate(false);
		lblProvincia.setWidth("-1px");
		lblProvincia.setHeight("-1px");
		lblProvincia.setValue("Provincia");
		mainLayout.addComponent(lblProvincia, "top:10.0px;left:191.0px;");

		// lblDistrito
		lblDistrito = new Label();
		lblDistrito.setImmediate(false);
		lblDistrito.setWidth("-1px");
		lblDistrito.setHeight("-1px");
		lblDistrito.setValue("Distrito");
		mainLayout.addComponent(lblDistrito, "top:10.0px;left:365.0px;");

		// cbxProvincia
		cbxProvincia = new ComboBox();
		cbxProvincia.setImmediate(false);
		cbxProvincia.setWidth("168px");
		cbxProvincia.setHeight("-1px");
		mainLayout.addComponent(cbxProvincia, "top:35.0px;left:191.0px;");

		// cbxDepartamento
		cbxDepartamento = new ComboBox();
		cbxDepartamento.setImmediate(false);
		cbxDepartamento.setWidth("160px");
		cbxDepartamento.setHeight("-1px");
		mainLayout.addComponent(cbxDepartamento, "top:35.0px;left:20.0px;");

		// cbxDistrito
		cbxDistrito = new ComboBox();
		cbxDistrito.setImmediate(false);
		cbxDistrito.setWidth("175px");
		cbxDistrito.setHeight("-1px");
		mainLayout.addComponent(cbxDistrito, "top:35.0px;left:365.0px;");

		// lblNombre
		lblNombre = new Label();
		lblNombre.setImmediate(false);
		lblNombre.setWidth("-1px");
		lblNombre.setHeight("-1px");
		lblNombre.setValue("Nombre del Lugar");
		mainLayout.addComponent(lblNombre, "top:74.0px;left:20.0px;");

		// txtNombre
		txtNombre = new TextField();
		txtNombre.setImmediate(false);
		txtNombre.setWidth("314px");
		txtNombre.setHeight("-1px");
		mainLayout.addComponent(txtNombre, "top:72.0px;left:123.0px;");

		// tblLugares
		tblLugares = new Table();
		tblLugares.setImmediate(false);
		tblLugares.setWidth("520px");
		tblLugares.setHeight("223px");
		mainLayout.addComponent(tblLugares, "top:106.0px;left:20.0px;");

		// btnBuscar
		btnBuscar = new Button();
		btnBuscar.setCaption("Buscar");
		btnBuscar.setIcon(new ThemeResource("images/botones/find.png"));
		btnBuscar.setImmediate(true);
		btnBuscar.setWidth("100px");
		btnBuscar.setHeight("-1px");
		mainLayout.addComponent(btnBuscar, "top:72.0px;left:440.0px;");

		// btnInicio
		btnInicio = new Boton();
		btnInicio.setIcon(new ThemeResource("images/botones/start.png"));
		btnInicio.setImmediate(false);
		btnInicio.setWidth("31px");
		btnInicio.setHeight("-1px");
		mainLayout.addComponent(btnInicio, "top:340.0px;left:120.0px;");

		// btnAtras
		btnAtras = new Boton();
		btnAtras.setIcon(new ThemeResource("images/botones/previous.png"));
		btnAtras.setImmediate(false);
		btnAtras.setWidth("30px");
		btnAtras.setHeight("-1px");
		mainLayout.addComponent(btnAtras, "top:340.0px;left:150.0px;");

		// btnSiguiente
		btnSiguiente = new Boton();
		btnSiguiente.setIcon(new ThemeResource("images/botones/next.png"));
		btnSiguiente.setImmediate(false);
		btnSiguiente.setWidth("30px");
		btnSiguiente.setHeight("-1px");
		mainLayout.addComponent(btnSiguiente, "top:340.0px;left:380.0px;");

		// btnFin
		btnFin = new Boton();
		btnFin.setIcon(new ThemeResource("images/botones/final.png"));
		btnFin.setImmediate(false);
		btnFin.setWidth("30px");
		btnFin.setHeight("-1px");
		mainLayout.addComponent(btnFin, "top:340.0px;left:410.0px;");

		// txtPaginaActual
		txtPaginaActual = new TextField();
		txtPaginaActual.setImmediate(false);
		txtPaginaActual.setWidth("30px");
		txtPaginaActual.setHeight("-1px");
		mainLayout.addComponent(txtPaginaActual, "top:340.0px;left:265.0px;");

		// lblPagina
		lblPagina = new Label();
		lblPagina.setImmediate(false);
		lblPagina.setWidth("-1px");
		lblPagina.setHeight("-1px");
		lblPagina.setValue("Página");
		mainLayout.addComponent(lblPagina, "top:342.0px;left:214.0px;");

		// lblSeparador
		lblSeparador = new Label();
		lblSeparador.setImmediate(false);
		lblSeparador.setWidth("-1px");
		lblSeparador.setHeight("-1px");
		lblSeparador.setValue("/");
		mainLayout.addComponent(lblSeparador, "top:342.0px;left:304.0px;");

		// lblTotalPaginas
		lblTotalPaginas = new Label();
		lblTotalPaginas.setImmediate(false);
		lblTotalPaginas.setWidth("-1px");
		lblTotalPaginas.setHeight("-1px");
		lblTotalPaginas.setValue("9999");
		mainLayout.addComponent(lblTotalPaginas, "top:342.0px;left:316.0px;");

		return mainLayout;
	}

}
